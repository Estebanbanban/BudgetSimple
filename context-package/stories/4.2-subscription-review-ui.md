# Story 4.2: Subscription Review and Confirmation UI

## Status

Draft

## Story

**As a** user,  
**I want** to confirm or reject detected subscriptions,  
**so that** the subscription list reflects reality.

## Acceptance Criteria

1. **Given** subscription candidates exist **when** I open the subscriptions review page **then** I see a list of pending candidates with merchant, estimated amount, frequency, and confidence score.
2. **Given** I am reviewing a subscription candidate **when** I view the candidate details **then** I can see the contributing transactions with dates, amounts, and categories.
3. **Given** I am reviewing a candidate **when** I take action **then** I can confirm it as a subscription, reject it, or adjust the merchant/category mapping.
4. **Given** I confirm a subscription **when** the confirmation is saved **then** the subscription status changes to "confirmed" and it appears in subscription summaries.
5. **Given** I reject a candidate **when** the rejection is saved **then** the subscription status changes to "rejected" and it is excluded from future summaries (or marked as reviewed to avoid re-detection).
6. **Given** I adjust merchant/category mapping **when** I save changes **then** the subscription is updated with the new mapping and confirmed automatically.
7. **Given** confirmed subscriptions exist **when** I view dashboard or cashflow map **then** confirmed subscriptions appear in relevant drilldowns and summaries.
8. **Given** I want to add a subscription manually **when** I use the "Add Subscription" action **then** I can create a subscription entry with merchant, amount, frequency, and category without requiring detection.

## Tasks / Subtasks

- [ ] Design subscription review UI layout (AC: 1, 2)
  - [ ] List view for pending candidates
  - [ ] Detail view/modal for candidate review
  - [ ] Transaction list component for contributing transactions
- [ ] Create subscription review page component (AC: 1, 2, 3)
  - [ ] Candidate list with status indicators
  - [ ] Review detail panel/modal
  - [ ] Action buttons (Confirm/Reject/Edit)
- [ ] Implement subscription confirmation API endpoint (AC: 4)
  - [ ] PATCH /api/subscriptions/:id/confirm
  - [ ] Update subscription status and confirmed_date
- [ ] Implement subscription rejection API endpoint (AC: 5)
  - [ ] PATCH /api/subscriptions/:id/reject
  - [ ] Update subscription status to rejected
- [ ] Implement subscription update API endpoint (AC: 6)
  - [ ] PATCH /api/subscriptions/:id
  - [ ] Allow updating merchant, category, amount, frequency
- [ ] Create manual subscription creation UI and API (AC: 8)
  - [ ] "Add Subscription" form/modal
  - [ ] POST /api/subscriptions (manual creation)
  - [ ] Pre-fill with user input, set status to confirmed
- [ ] Integrate confirmed subscriptions with dashboard/cashflow (AC: 7)
  - [ ] Update dashboard queries to include confirmed subscriptions
  - [ ] Update cashflow map to show subscription flows
  - [ ] Ensure drilldowns include subscription transactions
- [ ] Add automated tests for review workflow (AC: 3, 4, 5, 6)
  - [ ] Unit tests for API endpoints
  - [ ] Integration tests for confirmation/rejection flow
  - [ ] E2E tests for review UI workflow

## Dev Notes

### Previous Story Insights

- Subscription detection exists from Story 4.1
- Transaction data model exists from Epic 2
- Category system exists from Epic 2
- Dashboard drilldowns exist from Epic 3

### Data Models

- Subscription table (from Story 4.1): status field supports pending/confirmed/rejected
- Subscription update: merchant, category_id, estimated_monthly_amount, frequency can be edited
- Manual creation: same schema as detected subscriptions, but user-provided

### API Specifications

- `GET /api/subscriptions/candidates` - Get pending candidates (from Story 4.1)
- `GET /api/subscriptions/candidates/:id` - Get candidate details (from Story 4.1)
- `PATCH /api/subscriptions/:id/confirm` - Confirm a subscription candidate
- `PATCH /api/subscriptions/:id/reject` - Reject a subscription candidate
- `PATCH /api/subscriptions/:id` - Update subscription details (merchant, category, amount, frequency)
- `POST /api/subscriptions` - Create subscription manually (merchant, amount, frequency, category)

### Component Specifications

- Review page: `/subscriptions/review` or `/subscriptions?tab=review`
- List view: Table or card layout showing pending candidates
- Detail view: Side panel or modal showing candidate details and contributing transactions
- Action buttons: Confirm (primary), Reject (secondary), Edit (tertiary)
- Manual add: Button/modal for creating subscriptions manually

### File Locations

- Frontend page: `budgetsimple-web/src/app/subscriptions/review/page.tsx` (or similar)
- Frontend components: `budgetsimple-web/src/components/subscriptions/ReviewList.tsx`, `SubscriptionDetail.tsx`, `AddSubscriptionForm.tsx`
- Backend routes: `budgetsimple-api/src/routes/subscriptions.ts` (extend from Story 4.1)
- Backend service: `budgetsimple-api/src/services/subscriptions.ts` (extend from Story 4.1)

### Technical Constraints

- Must respect user isolation (RLS policies)
- UI should be responsive (desktop-first per NFR1)
- Confirmation/rejection should be immediate (optimistic updates with error handling)
- Manual creation should validate required fields (merchant, amount, frequency)

### Project Structure Notes

- Follow existing UI patterns from Epic 3 dashboard
- Use React Query for subscription data fetching and mutations
- Follow existing form patterns for manual subscription creation

### Testing

- Unit tests for API endpoints (confirm, reject, update, create)
- Integration tests for review workflow
- E2E tests for review UI (list → detail → confirm/reject)
- E2E tests for manual subscription creation

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2025-01-xx | 0.1     | Draft story created | Scrum Master |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

## QA Results

TBD
