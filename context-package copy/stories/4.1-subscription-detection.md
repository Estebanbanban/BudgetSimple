# Story 4.1: Subscription Detection (Recurring Pattern Candidates)

## Status

Draft

## Story

**As a** user,  
**I want** the app to detect likely subscriptions,  
**so that** I can identify recurring spend quickly.

## Acceptance Criteria

1. **Given** I have at least several weeks of transactions **when** the system analyzes transactions for recurring patterns **then** it produces a list of subscription candidates with estimated monthly cost.
2. **Given** subscription candidates are detected **when** I view the candidates **then** each candidate shows the merchant name, estimated monthly amount, frequency (monthly/bi-weekly/quarterly/annual), and confidence score.
3. **Given** a subscription candidate exists **when** I request details **then** I can see the contributing transactions that led to the detection (with dates and amounts).
4. **Given** transactions are analyzed **when** the detection algorithm runs **then** it groups transactions by merchant and analyzes date intervals to identify recurring patterns.
5. **Given** a recurring pattern is detected **when** the system calculates the subscription amount **then** it uses the average amount from contributing transactions with variance tolerance (e.g., Â±5%).
6. **Given** transactions have inconsistent amounts **when** the detection runs **then** candidates with high variance are flagged with lower confidence scores or excluded if variance exceeds threshold.
7. **Given** a subscription candidate is detected **when** the system stores it **then** it includes metadata: merchant, category (if available), estimated_monthly_amount, frequency, first_detected_date, confidence_score, contributing_transaction_ids.

## Tasks / Subtasks

- [ ] Design subscription detection algorithm (AC: 4)
  - [ ] Group transactions by merchant/description similarity
  - [ ] Analyze date intervals to detect frequency patterns
  - [ ] Calculate average amount and variance
  - [ ] Implement confidence scoring
- [ ] Create subscription data model and database schema (AC: 7)
  - [ ] Subscription table with required fields
  - [ ] Subscription-transaction mapping table
  - [ ] RLS policies for user isolation
- [ ] Implement detection service/API endpoint (AC: 1, 4, 5, 6)
  - [ ] Backend service to analyze transactions
  - [ ] Pattern matching logic
  - [ ] Frequency detection (monthly, bi-weekly, quarterly, annual)
  - [ ] Amount variance calculation
- [ ] Create API endpoint to retrieve subscription candidates (AC: 2, 3)
  - [ ] GET endpoint with user-scoped results
  - [ ] Include contributing transaction details
  - [ ] Return confidence scores and metadata
- [ ] Add automated tests for detection algorithm (AC: 4, 5, 6)
  - [ ] Unit tests for pattern matching
  - [ ] Unit tests for frequency detection
  - [ ] Unit tests for variance calculation
  - [ ] Integration tests with sample transaction data

## Dev Notes

### Previous Story Insights

- Transaction data model exists from Epic 2 (Story 2.1)
- Category system exists from Epic 2
- User authentication and RLS are in place from Epic 1

### Data Models

- **Subscriptions table**: id, user_id, merchant, category_id (nullable), estimated_monthly_amount, frequency, first_detected_date, confirmed_date (nullable), status (pending/confirmed/rejected), confidence_score, created_at, updated_at
- **Subscription_transactions table**: subscription_id, transaction_id (many-to-many relationship)
- **Detection metadata**: Store pattern_type, contributing_transaction_ids as JSONB or separate table

### API Specifications

- `POST /api/subscriptions/detect` - Trigger detection analysis for user's transactions
- `GET /api/subscriptions/candidates` - Get pending subscription candidates for user
- `GET /api/subscriptions/candidates/:id` - Get candidate details with contributing transactions

### Component Specifications

- Detection can run as background job or on-demand
- Frontend will call detection endpoint and display results
- Consider caching detection results to avoid re-computation

### File Locations

- Backend: `budgetsimple-api/src/routes/subscriptions.ts` (or similar)
- Backend service: `budgetsimple-api/src/services/subscription-detection.ts`
- Frontend: `budgetsimple-web/src/app/subscriptions/page.tsx` (or similar)
- Frontend components: `budgetsimple-web/src/components/subscriptions/` (to be created)

### Technical Constraints

- Must respect user isolation (RLS policies)
- Detection should be efficient for typical personal datasets (avoid N+1 queries)
- Consider batch processing for large transaction sets
- Detection algorithm should be deterministic and explainable

### Project Structure Notes

- Follow existing API patterns from Epic 2
- Use OpenAPI contract for subscription endpoints
- Frontend generates typed client from OpenAPI spec

### Testing

- Unit tests for detection algorithm with various patterns
- Integration tests for API endpoints
- E2E tests for detection workflow (if UI exists in this story)

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2025-01-xx | 0.1     | Draft story created | Scrum Master |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

## QA Results

TBD
