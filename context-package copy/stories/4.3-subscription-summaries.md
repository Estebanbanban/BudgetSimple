# Story 4.3: Subscription Summaries ("Subscriptions per Month")

## Status

Draft

## Story

**As a** user,  
**I want** a subscriptions summary,  
**so that** I know my recurring spend and can reduce it if needed.

## Acceptance Criteria

1. **Given** I have confirmed subscriptions **when** I open subscription summaries **then** I see total subscriptions per month (sum of all confirmed subscription monthly amounts).
2. **Given** I have confirmed subscriptions **when** I view the breakdown **then** I see subscriptions grouped by merchant with individual monthly amounts.
3. **Given** I have confirmed subscriptions **when** I view the breakdown **then** I see subscriptions grouped by category with subtotals.
4. **Given** a subscription summary item exists **when** I click on it **then** I am taken to a drilldown showing the contributing transactions for that subscription.
5. **Given** subscription summaries are displayed **when** I view the summary **then** each subscription shows merchant name, monthly amount, frequency, category, and last transaction date.
6. **Given** I have subscription data **when** I view the dashboard **then** subscription summaries are accessible via a dashboard widget or link (integration with Epic 3).
7. **Given** I have subscription data **when** I view the cashflow map **then** subscriptions appear as a node/flow in the visualization (integration with Epic 5).
8. **Given** subscription summaries exist **when** I export or share data **then** subscription totals are included in relevant exports (if export functionality exists).

## Tasks / Subtasks

- [ ] Design subscription summary UI layout (AC: 1, 2, 3, 5)
  - [ ] Total monthly spend card/display
  - [ ] Breakdown by merchant (table or list)
  - [ ] Breakdown by category (table or list)
  - [ ] Individual subscription cards/rows
- [ ] Create subscription summary page component (AC: 1, 2, 3, 5)
  - [ ] Summary header with total
  - [ ] Merchant breakdown section
  - [ ] Category breakdown section
  - [ ] Individual subscription list
- [ ] Implement subscription summary API endpoint (AC: 1, 2, 3)
  - [ ] GET /api/subscriptions/summary
  - [ ] Return total monthly amount, breakdowns by merchant and category
  - [ ] Include subscription details (merchant, amount, frequency, category, last_transaction_date)
- [ ] Implement subscription drilldown API endpoint (AC: 4)
  - [ ] GET /api/subscriptions/:id/transactions
  - [ ] Return contributing transactions for a subscription
  - [ ] Support date range filtering
- [ ] Create subscription drilldown UI component (AC: 4)
  - [ ] Transaction list for subscription
  - [ ] Link from summary to drilldown
  - [ ] Integration with existing transaction drilldown patterns
- [ ] Integrate subscription summaries with dashboard (AC: 6)
  - [ ] Dashboard widget showing total monthly subscriptions
  - [ ] Link to full subscription summary page
  - [ ] Integration with action items panel (if applicable)
- [ ] Integrate subscriptions with cashflow map (AC: 7)
  - [ ] Add subscriptions as a node/flow in cashflow visualization
  - [ ] Support clicking subscription node to show drilldown
  - [ ] Coordinate with Epic 5 implementation
- [ ] Add automated tests for summary functionality (AC: 1, 2, 3, 4)
  - [ ] Unit tests for summary calculation logic
  - [ ] Integration tests for summary API endpoint
  - [ ] E2E tests for summary page and drilldowns

## Dev Notes

### Previous Story Insights

- Subscription confirmation exists from Story 4.2
- Transaction data model exists from Epic 2
- Dashboard exists from Epic 3
- Cashflow map exists from Epic 5 (to be coordinated)

### Data Models

- Subscription table (from Story 4.1): confirmed subscriptions with estimated_monthly_amount
- Subscription_transactions table: links subscriptions to transactions
- Summary calculation: aggregate confirmed subscriptions by merchant and category

### API Specifications

- `GET /api/subscriptions/summary` - Get subscription summary (total, breakdowns by merchant/category)
- `GET /api/subscriptions` - Get all confirmed subscriptions for user (with details)
- `GET /api/subscriptions/:id/transactions` - Get contributing transactions for a subscription
- Response format: `{ total_monthly: number, by_merchant: [...], by_category: [...], subscriptions: [...] }`

### Component Specifications

- Summary page: `/subscriptions` or `/subscriptions/summary`
- Summary layout: Total card at top, then merchant breakdown, category breakdown, full list
- Dashboard widget: Small card showing total monthly subscriptions with link to full page
- Drilldown: Modal, side panel, or dedicated page showing subscription transactions
- Integration with cashflow map: Subscriptions appear as a flow/node (coordinate with Epic 5)

### File Locations

- Frontend page: `budgetsimple-web/src/app/subscriptions/page.tsx` (or `/subscriptions/summary`)
- Frontend components: `budgetsimple-web/src/components/subscriptions/SubscriptionSummary.tsx`, `SubscriptionBreakdown.tsx`, `SubscriptionDrilldown.tsx`
- Dashboard widget: `budgetsimple-web/src/components/dashboard/SubscriptionWidget.tsx` (or integrate into existing dashboard)
- Backend routes: `budgetsimple-api/src/routes/subscriptions.ts` (extend from Story 4.1, 4.2)
- Backend service: `budgetsimple-api/src/services/subscriptions.ts` (extend from Story 4.1, 4.2)

### Technical Constraints

- Must respect user isolation (RLS policies)
- Summary calculations should be efficient (consider caching if needed)
- Dashboard widget should load quickly (lazy load or lightweight query)
- Drilldown should support date range filtering

### Project Structure Notes

- Follow existing dashboard patterns from Epic 3
- Follow existing drilldown patterns from Epic 3
- Coordinate with Epic 5 for cashflow map integration
- Use React Query for data fetching

### Testing

- Unit tests for summary calculation logic (total, breakdowns)
- Integration tests for summary API endpoint
- E2E tests for summary page rendering and drilldowns
- Integration tests for dashboard widget
- Coordinate with Epic 5 for cashflow map integration tests

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2025-01-xx | 0.1     | Draft story created | Scrum Master |

## Dev Agent Record

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

## QA Results

TBD
